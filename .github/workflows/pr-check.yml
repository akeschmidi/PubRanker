name: PR Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  checks:
    name: Pull Request Checks
    runs-on: macos-15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.swift', '**/*.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-deriveddata-

    - name: Cache SPM
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Cache Homebrew
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Cellar/swiftlint
        key: ${{ runner.os }}-brew-swiftlint-${{ hashFiles('.github/workflows/pr-check.yml') }}
        restore-keys: |
          ${{ runner.os }}-brew-swiftlint-

    - name: Check Build
      id: build
      run: |
        xcodebuild build \
          -project PubRanker.xcodeproj \
          -scheme PubRanker \
          -destination 'platform=macOS' \
          -configuration Debug \
          -derivedDataPath $(pwd)/.derivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
      continue-on-error: true

    - name: Check SwiftLint
      id: lint
      run: |
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi
        swiftlint lint --quiet
      continue-on-error: true
      
    - name: Check File Changes
      run: |
        echo "üìù Ge√§nderte Dateien:"
        git diff --name-only origin/main...HEAD
        
    - name: Summary
      run: |
        echo "## Pull Request Checks üîç" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.build.outcome }}" == "success" ]; then
          echo "‚úÖ Build: Erfolgreich" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Build: Fehlgeschlagen" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.lint.outcome }}" == "success" ]; then
          echo "‚úÖ SwiftLint: Keine Fehler" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è SwiftLint: Warnings gefunden" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Pr√ºfen Sie die Details oben f√ºr mehr Informationen." >> $GITHUB_STEP_SUMMARY
        
    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const buildStatus = '${{ steps.build.outcome }}' === 'success' ? '‚úÖ' : '‚ùå';
          const lintStatus = '${{ steps.lint.outcome }}' === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
          
          const comment = `## ü§ñ PR Check Results
          
          | Check | Status |
          |-------|--------|
          | Build | ${buildStatus} |
          | SwiftLint | ${lintStatus} |
          
          Workflow run: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
